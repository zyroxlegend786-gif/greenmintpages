<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GreenPages</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:system-ui;background:#020617;color:#e5e7eb}
header{padding:14px 20px;border-bottom:1px solid #1e293b;display:flex;justify-content:space-between;align-items:center}
button{padding:8px 14px;border:none;border-radius:8px;font-weight:600;cursor:pointer}
.green{background:#22c55e;color:black}
.gray{background:#334155;color:white}
.red{background:#ef4444;color:white}
.card{background:#020617;border:1px solid #1e293b;border-radius:14px;padding:16px;margin-bottom:14px}
#app{max-width:1100px;margin:auto;padding:20px}
textarea{width:100%;height:280px;background:#020617;color:#22c55e;border:1px solid #334155;border-radius:12px;padding:14px;font-family:monospace}
iframe{width:100%;height:320px;border:1px solid #334155;border-radius:12px;background:white}
input{padding:10px;border-radius:8px;border:1px solid #334155;background:#020617;color:white}
.row{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
a{color:#38bdf8;text-decoration:none}
</style>
</head>

<body>
<header>
<b>ðŸŒ¿ GreenPages</b>
<div id="auth"></div>
</header>

<div id="app"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ---------------- FIREBASE ---------------- */
firebase.initializeApp({
  apiKey: "AIzaSyBJ-Ki5RueLv0_JatYBaoEatlZS4WD9ZMY",
  authDomain: "greenpages-cc200.firebaseapp.com",
  databaseURL: "https://greenpages-cc200-default-rtdb.firebaseio.com",
  projectId: "greenpages-cc200",
  storageBucket: "greenpages-cc200.firebasestorage.app",
  messagingSenderId: "939676595663",
  appId: "1:939676595663:web:39fe97fe23f31bebcd4eba"
});

const auth = firebase.auth();
const db = firebase.database();
const app = document.getElementById("app");
const authBox = document.getElementById("auth");

/* ---------------- STATE ---------------- */
let tempCode = localStorage.getItem("tempCode") ||
`<!DOCTYPE html><html><body><h1>Hello GreenPages ðŸŒ¿</h1></body></html>`;

let editingId = null;

/* ---------------- AUTH ---------------- */
auth.onAuthStateChanged(async user=>{
  const q = new URLSearchParams(location.search);

  // ðŸŒ Public site view
  if(q.get("site")){
    db.ref("sites/"+q.get("site")).once("value", s=>{
      if(s.exists()){
        document.open();
        document.write(s.val().html);
        document.close();
      }else{
        app.innerHTML="<h2>Site not found</h2>";
      }
    });
    return;
  }

  if(user){
    authBox.innerHTML = `${user.displayName}
      <button class="gray" onclick="auth.signOut()">Logout</button>`;
    dashboard();
  }else{
    authBox.innerHTML = `<button class="green" onclick="login()">Login</button>`;
    app.innerHTML = `<h2>Login to use GreenPages ðŸŒ¿</h2>`;
  }
});

function login(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

/* ---------------- DASHBOARD ---------------- */
function dashboard(){
  editingId=null;
  app.innerHTML=`
    <div class="card row">
      <h2>Dashboard</h2>
      <button class="green" onclick="newSite()">+ New Site</button>
    </div>
    <div id="list"></div>
  `;

  const list=document.getElementById("list");
  list.innerHTML="";

  db.ref("sites").orderByChild("uid")
  .equalTo(auth.currentUser.uid)
  .once("value", snap=>{
    snap.forEach(s=>{
      const d=s.val();
      list.innerHTML+=`
        <div class="card row">
          <b>${d.name}</b>
          <div>
            <a href="?site=${s.key}" target="_blank">Open</a>
            <button class="gray" onclick="editSite('${s.key}')">Edit</button>
            <button class="red" onclick="delSite('${s.key}')">Delete</button>
          </div>
        </div>
      `;
    });
  });
}

function delSite(id){
  if(confirm("Delete site?")){
    db.ref("sites/"+id).remove();
    dashboard();
  }
}

/* ---------------- IDE ---------------- */
function newSite(){
  editingId=null;
  tempCode=`<!DOCTYPE html><html><body><h1>Hello GreenPages ðŸŒ¿</h1></body></html>`;
  openIDE();
}

function editSite(id){
  db.ref("sites/"+id).once("value", s=>{
    editingId=id;
    tempCode=s.val().html;
    openIDE();
  });
}

function openIDE(){
  app.innerHTML=`
    <div class="card">
      <textarea id="code">${tempCode}</textarea><br><br>
      <button class="gray" onclick="preview()">Preview</button>
      <button class="green" onclick="deployUI()">Deploy</button>
      <button class="gray" onclick="dashboard()">Back</button>
    </div>
    <iframe id="view"></iframe>
  `;
  preview();
}

function preview(){
  tempCode=document.getElementById("code").value;
  document.getElementById("view").srcdoc=tempCode;
}

/* ---------------- DEPLOY ---------------- */
function deployUI(){
  app.innerHTML=`
    <div class="card">
      <input id="name" placeholder="site-name"><br><br>
      <button class="green" onclick="deploy()">Confirm Deploy</button>
      <button class="gray" onclick="openIDE()">Back</button>
    </div>
  `;
}

function deploy(){
  const name=document.getElementById("name").value.trim();
  if(!name) return alert("Enter site name");

  const data={
    uid:auth.currentUser.uid,
    name,
    html:tempCode,
    time:Date.now()
  };

  if(editingId){
    db.ref("sites/"+editingId).update(data);
    alert("Updated âœ…");
  }else{
    db.ref("sites").push(data);
    alert("Deployed ðŸš€");
  }
  dashboard();
}
</script>
</body>
</html>
